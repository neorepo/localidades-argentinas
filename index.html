<!DOCTYPE html>
<html lang="es" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Dynamic Select for ZIP CODE">
    <meta name="keywords"
        content="Códigos postales de localidades argentinas, CÓDIGO POSTAL, CPA, Códigos Postales, HTML, CSS, JavaScript, Ajax, Json">
    <meta name="author" content="Julio Cesar">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />

    <!-- select2-bootstrap4-theme -->
    <link href="https://raw.githack.com/ttskch/select2-bootstrap4-theme/master/dist/select2-bootstrap4.min.css"
        rel="stylesheet">

    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- Favicon -->
    <link rel="icon" href="location.png" sizes="16x16 32x32" type="image/png">

    <!-- Estilos  -->
    <style>
        label {
            font-weight: 600;
            margin-bottom: .25rem;
        }

        .output {
            border: 3px solid #37BBED;
            padding: 32px;
            border-radius: 5px;
            background-color: #f3faff;
        }

        .form-control:focus,
        .custom-select:focus {
            border-color: #0366d6;
        }
    </style>
    <title>Buscador de Códigos Postales - Localidades Argentinas</title>
</head>

<body>

    <nav class="navbar navbar-expand-md navbar-dark" style="background-color: #37BBED;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="font-weight: 500;">
                <img src="location.png" width="30" height="30" class="d-inline-block align-top"
                    alt="Imagen de icono de ubicación" loading="lazy">
                Buscador de Códigos Postales
            </a>
        </div>
    </nav>

    <main class="container mt-5 mb-4">

        <div class="mb-4">
            <h1 class="h3">Códigos Postales de Localidades Argentinas</h1>
        </div>

        <!-- Select Provincia -->
        <div class="mb-3">
            <label for="provincia">Provincia:</label>
            <select name="provincia" id="provincia" class="custom-select">
                <option value="">- Seleccione una provincia -</option>
                <option value="BUENOS AIRES">BUENOS AIRES</option>
                <option value="CATAMARCA">CATAMARCA</option>
                <option value="CHACO">CHACO</option>
                <option value="CHUBUT">CHUBUT</option>
                <option value="CORDOBA">CORDOBA</option>
                <option value="CORRIENTES">CORRIENTES</option>
                <option value="ENTRE RIOS">ENTRE RIOS</option>
                <option value="FORMOSA">FORMOSA</option>
                <option value="JUJUY">JUJUY</option>
                <option value="LA PAMPA">LA PAMPA</option>
                <option value="LA RIOJA">LA RIOJA</option>
                <option value="MENDOZA">MENDOZA</option>
                <option value="MISIONES">MISIONES</option>
                <option value="NEUQUEN">NEUQUEN</option>
                <option value="RIO NEGRO">RIO NEGRO</option>
                <option value="SALTA">SALTA</option>
                <option value="SAN JUAN">SAN JUAN</option>
                <option value="SAN LUIS">SAN LUIS</option>
                <option value="SANTA CRUZ">SANTA CRUZ</option>
                <option value="SANTA FE">SANTA FE</option>
                <option value="SANTIAGO DEL ESTERO">SANTIAGO DEL ESTERO</option>
                <option value="TIERRA DEL FUEGO">TIERRA DEL FUEGO</option>
                <option value="TUCUMAN">TUCUMAN</option>
            </select>
        </div>

        <!-- Select Localidad -->
        <div class="mb-3">
            <label for="localidad">Localidad:</label>
            <select name="localidad" id="localidad" class="custom-select">
                <option value="">- Seleccione una localidad -</option>
            </select>
        </div>

        <!-- Datos de salida -->
        <div class="text-center mt-5" id="output"></div>

    </main>

    <footer class="mt-auto py-3 text-center text-muted">
        <p>
            <small>
                Copyright © 2020 | Powered by Julio Cesar<br>
                <a href="https://github.com/neorepo/localidades-argentinas" target="_blank"
                    style="text-decoration: none;">GitHub</a>
            </small>
        </p>
    </footer>

    <script>

        $(document).ready(function () {
            $('#provincia').select2({
                theme: "bootstrap4",
                language: {
                    noResults: function () { return "No se encontraron resultados" }
                }
            });

            $('#localidad').select2({
                // placeholder: '- Seleccione una opción -',
                // allowClear: true,
                theme: "bootstrap4",
                minimumInputLength: 3,
                language: {
                    inputTooShort: function (e) {
                        var n = e.minimum - e.input.length, r = "Por favor, introduzca " + n + " car"; return r += 1 == n ? "ácter" : "acteres";
                    },
                    noResults: function () { return "No se encontraron resultados"; }
                }
            });
        });

        const selectProvincia = document.querySelector('select#provincia');
        const selectLocalidad = document.querySelector('select#localidad');

        // Variables globales
        var provincia, data;

        document.addEventListener('DOMContentLoaded', () => {

            initChangeProvincia();
            initChangeLocalidad();

        });

        // Inicializar el cambio de Provincia
        function initChangeProvincia() {
            if (selectProvincia) {
                selectProvincia.onchange = function (e) { return handleChangeProvincia(this, e); }
            }
        }

        // Manejar el cambio de Provincia
        function handleChangeProvincia(selectObj, objEvent) {
            if (selectLocalidad) {
                // Solo se habilitará cuando el índice seleccionado sea distinto de cero
                selectLocalidad.disabled = true;
                // Removemos opciones si las hay
                removeOptions(selectLocalidad);
                // Removemos datos de salida, si los hay
                output('');
                const selectedIndex = selectObj.selectedIndex;
                if (selectedIndex > 0) {
                    // Habilitamos el select de paises
                    selectLocalidad.disabled = false;
                    provincia = selectObj.options[selectedIndex].value;
                    const url = 'https://neorepo.github.io/localidades-argentinas/' + provincia.replaceAll(" ", "-").toLowerCase() + '.json';
                    // Solicitar datos al servidor
                    sendHttpRequest('GET', url, null, loadLocalities);
                }
            }
        }

        // Cargar las localidades
        function loadLocalities(response) {
            // Parseamos la respuesta del servidor
            data = JSON.parse(response);
            createOptions(data, selectLocalidad);
        }

        // Inicializar el cambio de Localidad
        function initChangeLocalidad() {
            if (selectLocalidad) {
                // En la carga del DOM desabilitamos el select de localidad
                selectLocalidad.disabled = true;
                selectLocalidad.onchange = function (e) { return handleChangeLocalidad(this, e); }
            }
        }

        // Manejar el cambio de Localidad
        function handleChangeLocalidad(selectObj, objEvent) {
            const selectedIndex = selectObj.selectedIndex;
            let message = '';
            if (selectedIndex > 0) {
                const obj = data[selectedIndex - 1];
                message += `<div class="output"><h3>${obj.nombre}, ${provincia}</h3><h4>Código postal: ${obj.cp}</h4></div>`;
            }
            // Mostrar datos
            output(message);
        }

        // Crea opciones en objetos select
        function createOptions(data, selectObj) {
            let newOpt;
            const fragment = document.createDocumentFragment();
            data.forEach(obj => {
                newOpt = document.createElement('option');
                newOpt.value = obj.id;
                newOpt.text = obj.nombre + " (" + obj.cp + ")";
                try {
                    fragment.add(newOpt);
                } catch (error) {
                    fragment.appendChild(newOpt);
                }
            });
            selectObj.appendChild(fragment);
        }

        // Remueve todas las opciones excepto el índice 0 (osea no remueve la primera opción)
        function removeOptions(selectObj) {
            let len = selectObj.options.length;
            while (len-- > 1) selectObj.remove(1);
        }

        // Datos de salida
        function output(message) {
            const output = document.querySelector('#output');
            if (output) output.innerHTML = message;
        }

        // Enviar solicitud al servidor
        function sendHttpRequest(method, url, data, callback) {
            const xhr = getXhr();
            xhr.onreadystatechange = processRequest;
            function getXhr() {
                if (window.XMLHttpRequest) {
                    return new XMLHttpRequest();
                } else {
                    return new ActiveXObject("Microsoft.XMLHTTP");
                }
            }
            function processRequest() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status == 200) {
                        if (callback) callback(xhr.responseText);
                    }
                }
            }
            xhr.open(method, url + ((/\?/).test(url) ? "&" : "?") + (new Date()).getTime());
            if (data && !(data instanceof FormData)) xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send(data);
        }

    </script>
</body>

</html>