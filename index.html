<!DOCTYPE html>
<html lang="es" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Dynamic Select for ZIP CODE">
    <meta name="keywords" content="Códigos postales de localidades argentinas, CÓDIGO POSTAL, CPA, Códigos Postales, HTML, CSS, JavaScript, Ajax, Json">
    <meta name="author" content="Julio Cesar">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Favicon -->
    <link rel="icon" href="favicon.png" sizes="16x16 32x32" type="image/png">

    <!-- Estilos  -->
    <style>
        .form-label {
            font-weight: 600;
            margin-bottom: .25rem;
        }

        .output {
            border: 3px solid #37BBED;
            padding: 32px;
            border-radius: 5px;
            background-color: #f3faff;
        }

        .material-icons {
            font-size: 32px;
            vertical-align: bottom;
        }
    </style>
    <title>Buscador de Códigos Postales - Localidades Argentinas</title>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark" style="background-color: #37BBED;">
        <div class="container-fluid">
            <!-- <a class="navbar-brand" href="#">Navbar</a> -->
            <span class="navbar-brand" style="font-weight: bold;text-transform: uppercase;">
                <span class="material-icons">place</span>
                Buscador de Códigos Postales
            </span>
        </div>
    </nav>

    <main class="container my-5 p-3">

        <div class="mb-3">
            <h1 class="h2">Códigos Postales de Localidades Argentinas</h1>
        </div>

        <div class="mb-3">
            <label for="provincia" class="form-label">Provincia:</label>
            <select name="provincia" id="provincia" class="form-select form-select-lg" required>
                <option value="" disabled>- Seleccione una provincia -</option>
                <option value="BUENOS AIRES">BUENOS AIRES</option>
                <option value="CATAMARCA">CATAMARCA</option>
                <option value="CHACO">CHACO</option>
                <option value="CHUBUT">CHUBUT</option>
                <!-- <option value="CIUDAD AUTONOMA DE BUENOS AIRES">CIUDAD AUTONOMA DE BUENOS AIRES</option> -->
                <option value="CORDOBA">CORDOBA</option>
                <option value="CORRIENTES">CORRIENTES</option>
                <option value="ENTRE RIOS">ENTRE RIOS</option>
                <option value="FORMOSA">FORMOSA</option>
                <option value="JUJUY">JUJUY</option>
                <option value="LA PAMPA">LA PAMPA</option>
                <option value="LA RIOJA">LA RIOJA</option>
                <option value="MENDOZA">MENDOZA</option>
                <option value="MISIONES">MISIONES</option>
                <option value="NEUQUEN">NEUQUEN</option>
                <option value="RIO NEGRO">RIO NEGRO</option>
                <option value="SALTA">SALTA</option>
                <option value="SAN JUAN">SAN JUAN</option>
                <option value="SAN LUIS">SAN LUIS</option>
                <option value="SANTA CRUZ">SANTA CRUZ</option>
                <option value="SANTA FE">SANTA FE</option>
                <option value="SANTIAGO DEL ESTERO">SANTIAGO DEL ESTERO</option>
                <option value="TIERRA DEL FUEGO">TIERRA DEL FUEGO</option>
                <option value="TUCUMAN">TUCUMAN</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="localidad" class="form-label">Localidad:</label>
            <select name="localidad" id="localidad" class="form-select form-select-lg" required>
                <option value="" disabled>- Seleccione una localidad -</option>
            </select>
        </div>

        <div class="text-center my-5" id="output"></div>

    </main>

    <footer class="mt-auto py-3 text-center text-muted">
        <p><small>Copyright © 2020 | Powered by Julio Cesar</small></p>
    </footer>

    <script>
        $(document).ready(function () {
            $('#provincia').select2({
                // theme: "classic",
                language: {
                    noResults: function () { return "No se encontraron resultados" }
                }
            });

            $('#localidad').select2({
                // placeholder: '- Seleccione una opción -',
                // allowClear: true,
                minimumInputLength: 3,
                language: {
                    inputTooShort: function (e) {
                        var n = e.minimum - e.input.length, r = "Por favor, introduzca " + n + " car"; return r += 1 == n ? "ácter" : "acteres"
                    },
                    noResults: function () { return "No se encontraron resultados" }
                }
            });
        });

        const selectProvincia = document.querySelector('select#provincia');
        const selectLocalidad = document.querySelector('select#localidad');
        const output = document.querySelector("#output");
        let data = [];

        document.addEventListener('DOMContentLoaded', (e) => {
            initOnchangeProvincia();
            initOnchangeLocalidad();
        });

        function initOnchangeLocalidad(params) {
            if (selectLocalidad) {
                selectLocalidad.onchange = function (e) { mostrarInfo(this, e); }
            }
        }

        function mostrarInfo(objSelect, e) {
            const idx = objSelect.selectedIndex;
            if (idx != 0) {
                const opt = data[idx - 1];
                if (output) {
                    output.classList.add("output");
                    output.innerHTML = `<h3>${opt.nombre}</h3><h4>Código postal: ${opt.cp}</h4>`;
                }
            } else {
                output.classList.remove("output");
                output.innerHTML = '';
            }
        }

        function initOnchangeProvincia() {
            if (selectProvincia) {
                selectProvincia.onchange = function (e) { initRequest(this, e); }
            }
        }

        function initRequest(objSelect, e) {
            if (objSelect.selectedIndex != 0) {
                let provincia = objSelect.value.toLowerCase();
                provincia = provincia.replaceAll(" ", "-");
                const method = 'GET';
                const url = 'https://neorepo.github.io/localidades-argentinas/' + provincia + '.json';
                fetchResource(method, url);
            } else {
                removeOptions(selectLocalidad);
            }
        }

        function fetchResource(method, url) {
            var client = new XMLHttpRequest();
            client.onload = handler;
            client.open(method, url + ((/\?/).test(url) ? "&" : "?") + (new Date()).getTime());
            client.send();
        }

        // https://www.w3.org/TR/WCAG20-TECHS/SCR19.html
        function processData(response) {
            if (selectLocalidad) {
                data = JSON.parse(response);
                const fragment = document.createDocumentFragment();
                removeOptions(selectLocalidad);
                let opt;
                data.forEach(obj => {
                    opt = document.createElement('option');
                    opt.value = obj.id;
                    opt.text = obj.nombre + " (" + obj.cp + ")";
                    try {
                        fragment.add(opt);
                    } catch (e) {
                        fragment.appendChild(opt);
                    }
                });
                selectLocalidad.appendChild(fragment);
            }
        }

        // remove the current options from the element select
        function removeOptions(objSelect) {
            // objSelect.options.length = 0;
            let len = objSelect.options.length;
            while (len-- > 1) {
                objSelect.remove(1);
            }

            output.classList.remove("output");
            // Removemos los datos de muestra
            output.innerHTML = '';
        }

        function handler() {
            if (this.status == 200 && this.responseText != null) {
                // success!
                processData(this.responseText);
            } else {
                // something went wrong
                console.log('Something went wrong!')
            }
        }
    </script>
</body>

</html>
